<data>

  <onLoad>
    <action>
        ev.getString = getString;
        ev.setString = setString;
        ev.getGlobal = getGlobal;
        ev.setGlobal = setGlobal;
        ev.getFlag = getFlag;
        ev.setFlag = setFlag;
        ev.player = player;
        ev.evalXml = evalXml;
        ev.setBack = setBack;
    </action>
  </onLoad>

  <action>
    ev = {};

    function wyrmQuest(v,?player) {
      if (player == null) player = ev.player;
      player.setFlag("wyrm_quest",v);
      if (getGlobal("tales_queen") != null)
      getGlobal("tales_queen").updateRenderer();
     }

    function checkOpen(player){
      if (ev == null || ev.player != player) return false;
      quests = getDataByType("wyrmQuest");
      for (quest in quests){
        if ( eval(quest.ready) && ( !player.hasQuest(quest.id) ) ){
          return true;
        }
      }
        for (quest in player.getQuests()){
          if (player.canCompleteQuest(quest.id) ) {
          return true;
        }
      }
      return false;
    }
  //<!-- &lt;option title="'+desc+'" size="small" /> -->
    function listQuest(quest,player){
      var name = "quests>" + quest.id;
      var desc = "quest.description>" + quest.id;

      if (quest.icon != null) icon = quest.icon; else icon = "wyrm.ico";
      if (quest.animation != null) anim = quest.animation; else anim = "single";
      if (quest.requirements != null) requires = quest.requirements; else requires = null;
        if (player.canCompleteQuest(quest.id) && anim == "single") anim = "single_green";
        else if (!player.hasQuest(quest.id) && anim == "single") anim = "single_gold";
        else if (player.hasQuest(quest.id) && !player.canCompleteQuest(quest.id) && !player.questComplete(quest.id) && anim == "single") anim = "single_red";
        else if (player.questComplete(quest.id) && eval(quest.loop) && anim == "single") anim = "single_light_blue";

      if (eval(quest.ready) || eval(quest.ready) == null){
        string =
        '&lt;listItem icon="'+icon+'" title="'+name+'" animation="'+anim+'">
        &lt;action>
        checkQuest(player,"'+quest.id+'");
        &lt;/action>
        &lt;tooltip type="requires" requires="quests.requires">
        '+requires+'
        &lt;/tooltip>
        &lt;closeWindows modal="true" />
        &lt;/listItem>';
        return string;
      }
      return null;
    }

    function checkQuest(player,q){
      quest = getData("wyrmQuest",q);
      if (!player.hasQuest(q) || ( eval(quest.loop) && player.questComplete(q) )){
        player.addQuest(getQuest(q));
          wyrmQuest(checkOpen(player),player);
          for (action in quest.start) for (child in action.children) eval(child.nodeValue);
        return "gave quest: " + q ;
      }
      else if (player.canCompleteQuest(q)){
        player.completeQuest(getQuest(q));
          wyrmQuest(checkOpen(player),player);
          for (action in quest.end) for (child in action.children) eval(child.nodeValue);
        return "completed quest: " + q;
      }
      return "failed to complete: " + q;
    }

  </action>
</data>
