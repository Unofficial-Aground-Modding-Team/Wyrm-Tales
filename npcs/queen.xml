<?xml version="1.0" encoding="UTF-8"?>
<data>

  <action>
    function wyrmModifyEquipment(player,slot,modifier){
      var item = player.equipment.get(slot).get();
      item.setName(Item.setParameter(item.getNameStr(), "m", modifier));
    }

    function wyrmUpgrade(item){
      try{throw
      var player=getLocalPlayer();
      var slot = getItem(item).xml.get('slot');
      var _slot = player.equipment.get(slot);
      var name = player.equipment.get(slot).get().getNameStr();
      player.equipment.forceEquip(slot, player, getItem(item).asItem());
      _slot.get().setName(name);
      }
      catch(e:Dynamic){trace('Upgrade Error' + e);}
    }

    function getWyrmQuest(player){
    if (
    !player.hasQuest('tales_sacrifice')
    ||
    (player.canCompleteQuest('tales_sacrifice') && player.hasQuest('tales_sacrifice'))
    ||
    (!player.hasQuest('golem_mine') && !player.hasQuest('tales_farming') && player.questComplete('tales_sacrifice'))
    ||
    player.canCompleteQuest('golem_mine')
    ||
    player.canCompleteQuest('tales_farming')
    ||
    (player.getFlag('WTGolemStatue') && !player.getFlag('learnGolem'))
    ){return true;}
    else return false;
    }
  </action>
  <npc id="npc_wyrm_queen" tile="wyrm_queen" icon="wyrm_queen.ico"/>
  <procedure id="wyrm_quests">
    <set id="this" value="area.getNPC('wyrm_house')"/>
    <choose>
    <section if="!player.hasQuest('tales_sacrifice')">
      <dialogue section="wyrm_queen" id="sacrifice1" speaker="this"/>
      <quest id="tales_sacrifice"/>
    </section>
    <section if="player.canCompleteQuest('tales_sacrifice') && player.hasQuest('tales_sacrifice')">
      <dialogue text="Good. Very good."/>
      <action>
        wyrmUpgrade('wyrm_weapon1');
        wyrmUpgrade('wyrm_armor1');
        wyrmUpgrade('wyrm_drill1');
      </action>
      <complete quest="tales_sacrifice" />
    </section>
    <section if="!player.hasQuest('golem_mine') && !player.hasQuest('tales_farming') && player.questComplete('tales_sacrifice')">
      <dialogue section="wyrm_queen" id="golem_mine1"/>
      <dialogue section="wyrm_queen" id="golem_mine2"/>
      <quest id="golem_mine"/>
      <quest id="tales_farming"/>
      <structure id="tales_wyrm_tunnel" x="1" y="0">
        <teleport area="wyrm_tales.golem_cave" x="32" y="32" allowReturn="true" />
      </structure>
      <structure id="tales_wyrm_tunnel" x="3" y="0">
        <teleport area="wyrm_tales.farming" x="1" y="1" allowReturn="true" />
      </structure>
      <dialogue text="Here, take this light orb to help you."/>
      <action>
        if (!getFlag("WT_light_buddy")){
          setFlag('WT_light_buddy',true);
        }
      </action>
      <item id="tales_light_buddy"/>
      <equip id="tales_light_buddy"/>
    </section>
    <section if="player.canCompleteQuest('golem_mine')">
      <dialogue section="wyrm_queen" id="golem_mine_complete"/>
      <complete quest="golem_mine" useResources="false"/>
    </section>
    <section if="player.canCompleteQuest('tales_farming')">
      <dialogue section="wyrm_queen" id="tales_farming_complete"/>
      <complete quest="tales_farming" useResources="false"/>
      <item id="plant_gem" count="-1" hidden="true"/>
      <item id="growth_seed"/>
    </section>
    <section if="getFlag('WTGolemStatue') && !getFlag('learnGolem')">
      <dialogue section="wyrm_queen" dialogue="golem_learn1"/>
    </section>
    <group>
      <dialogue section="wyrm_queen" id="tip1" speaker='this' />
      <dialogue section="wyrm_queen" id="tip2" speaker='this' />
      <dialogue section="wyrm_queen" id="tip3" speaker='this' />
      <dialogue section="wyrm_queen" id="tip4" speaker='this' />
    </group>
  </choose>
  </procedure>
  <quest id="tales_sacrifice" exp="50" giver="npc_wyrm_queen">
    <item id="dragonblood" count="5"/>
  </quest>
  <quest id="golem_mine" exp="100" giver="npc_wyrm_queen">
    <script id="getFlag('golem_cave')" name="wyrm_tales.dungeon>cave1" tile="golem.ico"/>
    <item id="spirit_gem" hidden="true"/>
  </quest>
  <quest id="tales_farming" exp="100" giver="npc_wyrm_queen">
    <script id="player.hasItem('wheat_seed') && player.hasItem('sugar_seed') && player.hasItem('orchard_seed') && player.hasItem('cotton_seed') && player.hasItem('rice_seed')" name="quest>gather_seeds" tile="tree_seed.ico"/>
    <!-- <item id="wheat_seed"/>
    <item id="sugar_seed"/>
    <item id="orchard_seed"/>
    <item id="cotton_seed"/>
    <item id="rice_seed"/> -->
    <item id="plant_gem" hidden="true"/>
  </quest>
  <quest id="tales_spirit_upgrade" exp="100" give="npc_wyrm_queen">
    <script id="player.questComplete('golem_mine')" name="quest>golem_mine" tile="golem.ico"/>
    <item id="spirit_gem" count="1"/>
    <item id="alter_gem" count="1"/>
  </quest>
</data>
